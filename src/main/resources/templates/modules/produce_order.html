<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sp=""
      lang="zh">
<head th:replace="includes/base :: common_header(~{},~{::link},~{::style})">
    <link rel="stylesheet" th:href="@{/css/tab-common.css}">
    <link rel="stylesheet" th:href="@{/css/edit-table.css}">
    <link rel="stylesheet" th:href="@{/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css}">
    <style>
        .form-control:disabled, .form-control[readonly] {
            /*background: #fff;*/
        }

        .operator-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: .2rem 1.25rem;
            background: #fff;
            border-top: 1px solid #c8ced3;
        }

        .table-fixed-container {
            max-height: calc(100vh - 300px);
        }

        .status-false {
            color: #f86c6b;
        }

        .status-true {
            color: #1da142;
        }

        .component-name {
            font-weight: bold;
            margin-bottom: 16px;
        }

        .component-name2 {
            font-weight: bold;
            margin: 16px 0 16px 16px;
        }

        .form-item {
            padding-left: 16px;
        }
    </style>
</head>
<body class="app">
<th:block th:replace="includes/base :: common_content(~{::div})">
    <div class="container-fluid">
        <div class="card">
            <div class="card-body">
                <form class="form-inline query-form-container" id="form-header">
                    <input type="hidden" id="id" th:value="${po.id}"/>
                    <div class="form-group">
                        <label class="col-form-label mr-2">生产单号</label>
                        <input class="form-control" type="text" id="code" name="code" readonly th:value="${po.code}">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label mr-2" for="remark">备注</label>
                        <input class="form-control" type="text" id="remark" name="remark" th:value="${po.remark}">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label mr-2">状态</label>
                        <sp:select  id="status" name="status" key="produce_order_status" class="form-control" th:value="${po.status}" hideAllItem/>
<!--                        <select class="form-control" name="status">-->
<!--                            <option value="PROCESSING" th:selected="${'PROCESSING' eq po.status.toString()}">进行中</option>-->
<!--                            <option value="DONE" th:selected="${'DONE' eq po.status.toString()}">已完成</option>-->
<!--                        </select>-->
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <form class="form-item" id="form-item">
                    <div id="table-container">
                    </div>
                </form>
            </div>
        </div>

        <div class="nav-tabs-boxed">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item"><a class="nav-link" th:classappend="${po.id == null ? 'active' :''}" data-toggle="tab" href="#tab-1" role="tab" aria-controls="home" aria-selected="false">物料清单</a></li>
                <li class="nav-item"><a class="nav-link" th:classappend="${po.id != null ? 'active' :''}" data-toggle="tab" href="#tab-2" role="tab" aria-controls="home" aria-selected="false" th:if="${po.id != null}">领料记录</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane" th:classappend="${po.id == null ? 'active' :''}" id="tab-1" role="tabpanel">
                    <div class="container-fluid" id="form-detail">
                        <div v-show="form.id" v-cloak>
                            <div class="card">
                                <div class="card-body">
                                    <div v-for="c in form.componentList">
<!--                                        <div class="component-name" v-text="c.description + '（' + c.quantity + c.unitText + '）'"></div>-->
                                        <form class="form-item">
                                            <div class="table-fixed-container">
                                                <table class="table-tbody table-editor table table-responsive-sm table-bordered table-sm">
                                                    <thead>
                                                    <tr>
                                                        <th style="width: 100px;"><label class="required">零部件物料</label></th>
                                                        <th><label>规格</label></th>
                                                        <th style="width: 100px;"><label class="required">颜色</label></th>
                                                        <th style="width: 80px;"><label>用量</label></th>
                                                        <th style="width: 80px;"><label>单位</label></th>
                                                        <th><label>备注</label></th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    <tr v-for="d in c.componentDetailList">
                                                        <template  v-if="!d.bomTemplate">
                                                            <td style="padding: 0;"><input class="form-control material" type="text" :disabled="d.type === 'MATERIAL'" :readonly="d.type === 'MATERIAL'" autocomplete="off" name="materialCode" v-model="d.value.materialCode" :component_detail_id="d.id" :component_id="d.componentId" :type_instance_id="d.typeInstanceId" required="required" :placeholder="d.placeholder" @click="showMaterialDialog"><input class="form-control" type="hidden" name="materialId" v-model="d.value.materialId" required="required" value=""></td><td v-if="!d.bomTemplate"><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialText" v-model="d.value.materialText"></td><td v-if="!d.bomTemplate"><select class="form-control" name="color" required="required" title="请填写颜色" disabled="disabled" v-model="d.value.color"><option v-for="option in d.options" v-text="option" :value="option"></option></select></td><td v-if="!d.bomTemplate"><input class="form-control" type="text" autocomplete="off" pattern="^\d+(\.\d{1,3})?$" title="必须数字" name="quantity" v-model="d.quantity" disabled required="required"></td><td v-if="!d.bomTemplate"><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="unitText" v-model="d.value.unitText" required="required"><input class="form-control" type="hidden" name="unit" required="required" v-model="d.value.unit"></td><td v-if="!d.bomTemplate" style="padding: 0;"><input class="form-control" type="text" v-model="d.value.remark" autocomplete="off" name="remark"></td>
                                                        </template>

                                                        <!--第二层-->
                                                        <td colspan="6" v-if="d.bomTemplate">
                                                            <div class="component-name2"><span v-text="d.value.materialText + ' ' +  d.value.quantity + '套'"></span></span></div>
                                                            <div v-for="cc in d.bomTemplate.componentList" style="padding-left: 16px">
<!--                                                                <div class="component-name2" v-text="cc.description + '（' + cc.quantity + cc.unitText + '）'"></div>-->
                                                                <!-- -->
                                                                <form class="form-item">
                                                                    <div class="table-fixed-container">
                                                                        <table class="table-tbody table-editor table table-responsive-sm table-bordered table-sm">
                                                                            <thead>
                                                                            <tr>
                                                                                <th style="width: 100px;"><label class="required">零部件物料</label></th>
                                                                                <th><label>规格</label></th>
                                                                                <th style="width: 100px;"><label class="required">颜色</label></th>
                                                                                <th style="width: 80px;"><label>用量</label></th>
                                                                                <th style="width: 80px;"><label>单位</label></th>
                                                                                <th><label>备注</label></th>
                                                                            </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                            <tr v-for="dd in cc.componentDetailList">
                                                                                <template  v-if="!dd.bomTemplate">
                                                                                    <td style="padding: 0;"><input class="form-control material" type="text" :disabled="dd.type === 'MATERIAL'" :readonly="dd.type === 'MATERIAL'" autocomplete="off" name="materialCode" v-model="dd.value.materialCode" :component_detail_id="dd.id" :component_id="dd.componentId" :type_instance_id="dd.typeInstanceId" required="required" :placeholder="dd.placeholder" @click="showMaterialDialog"><input class="form-control" type="hidden" name="materialId" v-model="dd.value.materialId" required="required" value=""></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialText" v-model="dd.value.materialText"></td><td><select class="form-control" name="color" required="required" title="请填写颜色" disabled="disabled" v-model="dd.value.color"><option v-for="option in dd.options" v-text="option" :value="option"></option></select></td><td><input class="form-control" type="text" autocomplete="off" pattern="^\d+(\.\d{1,3})?$" title="必须数字" name="quantity" v-model="dd.quantity" disabled required="required"></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="unitText" v-model="dd.value.unitText" required="required"><input class="form-control" type="hidden" name="unit" required="required" v-model="dd.value.unit"></td><td style="padding: 0;"><input class="form-control" type="text" v-model="dd.value.remark" autocomplete="off" name="remark"></td>
                                                                                </template>
                                                                                <!--第三层-->
                                                                                <td colspan="6" v-if="dd.bomTemplate">
                                                                                    <div class="component-name2"><span v-text="dd.value.materialText + ' ' +  dd.value.quantity + '套'"></span></span></div>
                                                                                    <div v-for="ccc in dd.bomTemplate.componentList" style="padding-left: 16px">
<!--                                                                                        <div class="component-name2" v-text="ccc.description + '（' + ccc.quantity + ccc.unitText + '）'"></div>-->
                                                                                        <!-- -->
                                                                                        <form class="form-item">
                                                                                            <div class="table-fixed-container">
                                                                                                <table class="table-tbody table-editor table table-responsive-sm table-bordered table-sm">
                                                                                                    <thead>
                                                                                                    <tr>
                                                                                                        <th style="width: 100px;"><label class="required">零部件物料</label></th>
                                                                                                        <th><label>规格</label></th>
                                                                                                        <th style="width: 100px;"><label class="required">颜色</label></th>
                                                                                                        <th style="width: 80px;"><label>用量</label></th>
                                                                                                        <th style="width: 80px;"><label>单位</label></th>
                                                                                                        <th><label>备注</label></th>
                                                                                                    </tr>
                                                                                                    </thead>
                                                                                                    <tbody>
                                                                                                    <tr v-for="ddd in ccc.componentDetailList">
                                                                                                        <template  v-if="!ddd.bomTemplate">
                                                                                                            <td style="padding: 0;"><input class="form-control material" type="text" :disabled="ddd.type === 'MATERIAL'" :readonly="ddd.type === 'MATERIAL'" autocomplete="off" name="materialCode" v-model="ddd.value.materialCode" :component_detail_id="ddd.id" :component_id="ddd.componentId" :type_instance_id="ddd.typeInstanceId" required="required" :placeholder="ddd.placeholder" @click="showMaterialDialog"><input class="form-control" type="hidden" name="materialId" v-model="ddd.value.materialId" required="required" value=""></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialText" v-model="ddd.value.materialText"></td><td><select class="form-control" name="color" required="required" title="请填写颜色" disabled="disabled" v-model="ddd.value.color"><option v-for="option in ddd.options" v-text="option" :value="option"></option></select></td><td><input class="form-control" type="text" autocomplete="off" pattern="^\dd+(\.\dd{1,3})?$" title="必须数字" name="quantity" v-model="ddd.quantity" disabled required="required"></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="unitText" v-model="ddd.value.unitText" required="required"><input class="form-control" type="hidden" name="unit" required="required" v-model="ddd.value.unit"></td><td style="padding: 0;"><input class="form-control" type="text" v-model="ddd.value.remark" autocomplete="off" name="remark"></td>
                                                                                                        </template>

                                                                                                        <!--第四层-->
                                                                                                        <td colspan="6" v-if="ddd.bomTemplate">
                                                                                                            <div class="component-name2"><span v-text="ddd.value.materialText + ' ' +  ddd.value.quantity + '套'"></span></span></div>
                                                                                                            <div v-for="cccc in ddd.bomTemplate.componentList" style="padding-left: 16px">
<!--                                                                                                                <div class="component-name2" v-text="cccc.description + '（' + cccc.quantity + cccc.unitText + '）'"></div>-->
                                                                                                                <!-- -->
                                                                                                                <form class="form-item">
                                                                                                                    <div class="table-fixed-container">
                                                                                                                        <table class="table-tbody table-editor table table-responsive-sm table-bordered table-sm">
                                                                                                                            <thead>
                                                                                                                            <tr>
                                                                                                                                <th style="width: 100px;"><label class="required">零部件物料</label></th>
                                                                                                                                <th><label>规格</label></th>
                                                                                                                                <th style="width: 100px;"><label class="required">颜色</label></th>
                                                                                                                                <th style="width: 80px;"><label>用量</label></th>
                                                                                                                                <th style="width: 80px;"><label>单位</label></th>
                                                                                                                                <th><label>备注</label></th>
                                                                                                                            </tr>
                                                                                                                            </thead>
                                                                                                                            <tbody>
                                                                                                                            <tr v-for="dddd in cccc.componentDetailList">
                                                                                                                                <td v-if="!dddd.bomTemplate" style="padding: 0;"><input class="form-control material" type="text" :disabled="dddd.type === 'MATERIAL'" :readonly="dddd.type === 'MATERIAL'" autocomplete="off" name="materialCode" v-model="dddd.value.materialCode" :component_detail_id="dddd.id" :component_id="dddd.componentId" :type_instance_id="dddd.typeInstanceId" required="required" :placeholder="dddd.placeholder" @click="showMaterialDialog"><input class="form-control" type="hidden" name="materialId" v-model="dddd.value.materialId" required="required" value=""></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialText" v-model="dddd.value.materialText"></td><td><select class="form-control" name="color" required="required" title="请填写颜色" disabled="disabled" v-model="dddd.value.color"><option v-for="option in dddd.options" v-text="option" :value="option"></option></select></td><td><input class="form-control" type="text" autocomplete="off" pattern="^\ddd+(\.\ddd{1,3})?$" title="必须数字" name="quantity" v-model="dddd.quantity" disabled required="required"></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="unitText" v-model="dddd.value.unitText" required="required"><input class="form-control" type="hidden" name="unit" required="required" v-model="dddd.value.unit"></td><td style="padding: 0;"><input class="form-control" type="text" v-model="dddd.value.remark" autocomplete="off" name="remark"></td>


                                                                                                                            </tr>
                                                                                                                            </tbody>
                                                                                                                        </table>
                                                                                                                    </div>
                                                                                                                </form>
                                                                                                                <!-- -->
                                                                                                            </div>
                                                                                                        </td>
                                                                                                    </tr>
                                                                                                    </tbody>
                                                                                                </table>
                                                                                            </div>
                                                                                        </form>
                                                                                        <!-- -->
                                                                                    </div>
                                                                                </td>
                                                                            </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </form>
                                                                <!-- -->
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div id="materialDetailInput" style="display: none"></div>
                    </div>
                </div>
                <div class="tab-pane"  th:classappend="${po.id != null ? 'active' :''}" id="tab-2" role="tabpanel">
                    <div id="goods_receipt_container" role="tabpanel">
                        <div class="table-fixed-container">
                            <table class="table table-responsive-sm table-bordered table-striped table-sm table-thead">
                                <thead>
                                <tr>
                                    <th style="width: 50px" data-index>序号</th>
                                    <th style="width: 100px" class="sortable active asc">物料</th>
                                    <th>规格</th>
                                    <th>颜色</th>
                                    <th style="width: 100px">基本单位</th>
                                    <th style="width: 100px" class="sortable text-right">领料数量</th>
                                    <th style="width: 120px" class="sortable text-right" data-sort-type="number">已领料数量</th>
                                    <th style="width: 120px" class="sortable text-right" data-sort-type="number">待领料数量</th>
                                    <th style="width: 90px" class="sortable">状态</th>
                                    <th style="width: 120px">物料凭证</th>
                                </tr>
                                </thead>
                            </table>
                            <table class="table table-responsive-sm table-bordered table-striped table-sm table-tbody">
                                <tbody>
                                <tr th:each="s: ${goodsReceiptItemList}">
                                    <td th:text="${sStat.index + 1}" data-index></td>
                                    <td th:text="${s.materialCode}" th:data-sort-value="${s.materialCode}"></td>
                                    <td th:text="${s.materialText}" th:data-sort-value="${s.materialText}"></td>
                                    <td th:text="${s.color}" th:data-sort-value="${s.color}"></td>
                                    <td th:text="${s.unitText}" th:data-sort-value="${s.unitText}"></td>
                                    <td th:text="${#numbers.formatDecimal(s.quantity,1,'COMMA',2,'POINT')}" th:data-sort-value="${s.quantity}" th:class="text-right"></td>
                                    <td th:text="${#numbers.formatDecimal(s.goodsReceiptQuantity,1,'COMMA',2,'POINT')}" th:data-sort-value="${s.goodsReceiptQuantity}" th:class="text-right"></td>
                                    <td th:text="${#numbers.formatDecimal(s.openQuantity,1,'COMMA',2,'POINT')}" th:data-sort-value="${s.openQuantity}" th:class="text-right"></td>
                                    <td th:class="${'status-' + s.complete}" th:data-sort-value="${s.complete}" th:text="${s.complete == true ? '已完成' : '未完成'}"></td>
                                    <td>
                                        <a href="javascript:;" th:onclick="openOnNewTab('[(${s.id})]', '[(${\'/reports/699659248728047616?root_reference_code=\'+s.produceOrderCode+\'&root_reference_item_id=\'+s.id+\'&material_id=\' + s.materialId})]', '物料凭证')">详情</a>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dialogInput" style="display: none"></div>
        <sp:select class="hidden" id="color"  key="COLOR" emptyItemText/>
        <div class="operator-bar text-center" id="operator-bar">
            <button class="btn btn-primary" type="button" name="send" onclick="send()">
                <i class="fa fa-save"></i> 保存</button>
        </div>
    </div>
</th:block>
<th:block th:replace="includes/base :: common_js(~{::script})">
    <script th:src="@{/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js}"></script>
    <script th:src="@{/plugins/bootstrap-datepicker/js/bootstrap-datepicker.zh-CN.min.js}"></script>
    <script type="text/javascript" th:src="@{/plugins/jquery.form2json.js}"></script>

    <script th:src="@{/editable-table/editable-table.js}"></script>
    <script th:src="@{/js/jquery.table.js}"></script>
    <script th:src="@{/js/editable-table-plus.js}"></script>

    <script th:src="@{/js/jquery.dialogInput.js}"></script>
    <script th:src="@{/js/editable-table-plus-customize_type.js}"></script>

    <script th:inline="javascript">
        let isAdd = /*[[${po.id == null}]]*/
        let formHeader = document.getElementById('form-header');
        let formItem = document.getElementById('form-item');

        function showDetail($tr, materialId, itemId) {
            if (materialId && $tr[0].form && materialId === $tr[0].form.materialId) {
                 vue.$data.form = $tr[0].form
            } else if (materialId) {
                $.get('/produce_orders/bom?materialId=' + materialId + (itemId ? ('&itemId=' + itemId) : ''), function (res) {
                    res.materialId = materialId
                    $tr[0].form = vue.$data.form = res
                })
            }
        }

        // 可编辑表格初始化
        let $editableTable = $('#table-container').editableTablePlus({
            customizeType,
            showRowNumber: true, // 是否显示行号
            allowEmpty: false, // 表格允许为空,
            highlight: true,
            rowClick: function (context, $tr, row) {
                showDetail($tr, row.materialId, row.id)
            },
            beforeDeleteRow: function (context, $tr, row) {
                // 删除对应的物料清单
                if (context.options.activeIndex === ($tr.index() + 1)) {
                    vue.$data.form = {}
                }

                return true
            },
            columnConfigs: [
                {
                    type: "hidden",
                    name: "batchCode"
                },
                {
                    type: "material",
                    name: "materialId",
                    title: "产成品物料",
                    width: 100,
                    required: true,
                    mode: 'single', // 多选,
                    reportId: '719185652091981824',
                    // params: {categoryId: "717389543182962688"},
                    beforeShow: function ($tr, context) {
                        return true;
                    },
                    selected: function ($tr, row) {
                        $tr.find(':input[name=color]')
                            .attr('disabled', !row.batchManagement)
                            .attr('readonly', !row.batchManagement)

                        showDetail($tr, row.id)
                    }
                },
                {
                    type: "label",
                    name: "materialText",
                    title: "规格"
                },
                {
                    type: "select",
                    name: "color",
                    width: 100,
                    title: "颜色",
                    datasource: $('#color'),
                    required: true,
                    disabled: true
                },
                {
                    type: "decimal",
                    name: "quantity",
                    title: "数量",
                    width: 100,
                    required: true,
                    align: 'right'
                },
                {
                    type: "text_label",
                    name: "unit",
                    title: "单位",
                    width: 100,
                    disabled: true,
                    required: false,
                },
                {
                    type: "text",
                    title: "备注",
                    name: "remark",
                }
            ]
        })

        // end

        function valid() {
            var formHeaderValidity = formHeader.checkValidity()
            var formItemValidity = formItem.checkValidity()
            formHeader.classList.add('was-validated')
            formItem.classList.add('was-validated')
            return formHeaderValidity && formItemValidity;
        }

        function reset() {
            formHeader.classList.remove('was-validated')
            formItem.classList.remove('was-validated')

            $editableTable.editableTablePlus('clear')

            $("form.readonly :input").prop("disabled", false);
            $("form-item #table tr:last-child").prop("disabled", false);
        }

        function send() {
            if (!valid()) {
                return
            }
            let detailValid = true
            let params = {}

            params['itemList'] = $editableTable.editableTablePlus('getValue')

            for (let index in params['itemList']) {
                let item = params['itemList'][index]

                if (item.color) {
                    let res = [];
                    for (let i = 0; i < item.color.length; i++) {
                        res[i] = ("00" + item.color.charCodeAt(i).toString(16)).slice(-4);
                    }
                    item.batchCode = res.join("")
                } else {
                    item.batchCode = null
                }

                // 获取value
                let valueList = []
                checkAndGetValueList($('#table-container table.table-tbody tbody tr').eq(index)[0].form, valueList, parseInt(index))
                if (!detailValid) {
                    return;
                }

                item['itemList'] = valueList
            }

            function checkAndGetValueList(tpl, valueList, index) {
                if (!detailValid) {
                    return;
                }

                if (tpl) {
                    for(let component of tpl.componentList) {
                        for (let componentDetail of component.componentDetailList) {
                            if (!componentDetail.value.materialId) {
                                toastr.error('第 '+(index + 1)+' 行产成品的物料清单有【物料】没有填写！')
                                detailValid = false
                                return
                            }

                            if (componentDetail.value.is_batch && !componentDetail.value.color) {
                                toastr.error('第 '+(index + 1)+' 行产成品的物料清单有物料没有填写【颜色】！')
                                detailValid = false
                                return
                            }

                            if (componentDetail.value.color) {
                                let res = [];
                                for (let i = 0; i < componentDetail.value.color.length; i++) {
                                    res[i] = ("00" + componentDetail.value.color.charCodeAt(i).toString(16)).slice(-4);
                                }

                                componentDetail.value.batchCode = res.join("")
                            } else {
                                componentDetail.value.batchCode = null
                            }


                            if (componentDetail.bomTemplate) {
                                checkAndGetValueList(componentDetail.bomTemplate, valueList, index)
                            } else {
                                valueList.push({...componentDetail.value, ...{quantity: componentDetail.quantity}})
                            }
                        }
                    }
                }
            }

            params = $.extend({},
                params, $('#form-header').form2json({allowEmptyMultiVal:true})); //合并参数

            $.ajax({
                url: '/produce_orders',
                type: "POST",
                data: JSON.stringify(params),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function(res){
                    toastr.success('生产单保存成功');
                    if (isAdd) {
                        window.location = '/produce_orders/'+res.id+'?readonly=true'
                    }
                    reloadTab('produce_order_list')
                }
            });
        }

        $('#goods_receipt_container').table({
            fixedHead: true
        })

        let itemList = /*[[${po.itemList}]]*/
        let valueMap =  /*[[${bomTemplate}]]*/

        loadItem(itemList)
        function loadItem(itemList) {
            if (itemList && itemList.length > 0) {
                $editableTable.editableTablePlus('setValue', itemList).editableTablePlus('setActiveIndex', 1)
            }
        }

        // 物料清单选择 detail
        let materialDetailInput = $('#materialDetailInput').dialogInput({
            title: '选择物料',
            reportId: '697147523487240192',
            labelDisplay: function (row) {
                return row.name + ' ' + (!row.specification ? '' : row.specification)
            },
            selected: function (row) {
                console.log(row)
                if ("createEvent" in document) {
                    var evt = document.createEvent("HTMLEvents");
                    evt.initEvent("input", false, true);
                    currentMaterialDom.dispatchEvent(evt);
                }
                else
                    currentMaterialDom.fireEvent("input");

                let form_data = vue.form

                // 递归设置物料信息
                let break_flag = false
                fill(form_data, this)
                function fill(tpl, context) {
                    if (break_flag) {
                        return
                    }

                    if(tpl) {
                        for (let c of tpl.componentList) {
                            if (break_flag) {
                                break
                            }

                            for (d of c.componentDetailList) {
                                if (d.componentId === currentMaterialDom.getAttribute('component_id') && d.typeInstanceId === currentMaterialDom.getAttribute('type_instance_id')) {
                                    d.value.is_batch = row.batchManagement
                                    d.value.materialId = row.id
                                    d.value.materialCode = row.code
                                    d.value.materialText = context.labelDisplay(row)
                                    d.value.unit = row.base_unit
                                    d.value.unitText = row.base_unit_name
                                    d.value.componentDetailId = currentMaterialDom.getAttribute('component_detail_id')
                                    // d.options = [...document.getElementById('color').options].map(o => o.text)
                                    break_flag = true
                                    break
                                }

                                //
                                if (!break_flag && d.bomTemplate) {
                                    fill(d.bomTemplate, context)
                                }
                            }
                        }
                    }
                }

                vue.form = form_data

                $(currentMaterialDom).parent().parent().find(':input[name=color]')
                    .attr('disabled', !row.batchManagement)
                    .attr('readonly', !row.batchManagement)
            }
        })

        let vue = new Vue({
            el: '#form-detail',
            data: {
                form: {

                }
            },
            mounted: function () {
                if (itemList && itemList.length > 0) {
                    $editableTable
                        .editableTablePlus('each',  (index, context, $tr, row) => {
                            let value = valueMap[row.id]
                            if(index === 0) {
                                this.form = value
                            }

                            value.materialId = row.materialId
                            $tr[0].form = value
                        })
                }
            },
            methods: {
                showMaterialDialog: function (e) {
                    materialDetailInput.dialogInput('setParams', {'categoryId' : e.target.getAttribute('type_instance_id')})
                    materialDetailInput.click();
                    currentMaterialDom = e.target
                },
                send() {
                }
            }
        })
    </script>
</th:block>
</body>
</html>