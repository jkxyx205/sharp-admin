<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sp=""
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      lang="zh">
<head th:replace="includes/base :: common_header(~{},~{::link},~{::style})">
    <link rel="stylesheet" th:href="@{/css/tab-common.css}">
    <link rel="stylesheet" th:href="@{/css/edit-table.css}">
    <link rel="stylesheet" th:href="@{/plugins/multiple-select/multiple-select.min.css}">
    <link rel="stylesheet" th:href="@{/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css}">
    <style>
        .form-control:disabled, .form-control[readonly] {
            /*background: #fff;*/
        }

        .operator-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: .2rem 1.25rem;
            background: #fff;
            border-top: 1px solid #c8ced3;
        }

        /*#form-item .table-fixed-container {*/
        /*    max-height: calc(100vh - 630px);*/
        /*}*/

        @media screen and (min-width: 576px) {
            .card-body-scroll-panel {
                max-height: inherit;
            }
        }

        /*#goods_receipt_container .table-fixed-container {*/
        /*    max-height: 350px;*/
        /*}*/

        /*.card-body-scroll-panel {*/
        /*    max-height: 350px;*/
        /*}*/

        .table-fixed-container > table {
            margin-bottom: 0;
        }

        .status-false {
            color: #f86c6b;
        }

        .status-true {
            color: #1da142;
        }

        .component-name {
            font-weight: bold;
            margin-bottom: 16px;
        }

        .component-name2 {
            font-weight: bold;
            margin: 12px 0 12px 12px;
            color: #73818f;
        }

        #form-detail thead {
            display: none;
        }

        #form-detail tbody tr td:nth-child(1) {
            width: 135px;
        }

        #form-detail tbody tr td:nth-child(5),
        #form-detail tbody tr td:nth-child(6) {
            width: 60px;
        }
    </style>
</head>
<body class="app">
<th:block th:replace="includes/base :: common_content(~{::div})">
    <div class="container-fluid">
        <div class="card">
            <div class="card-body">
                <form class="form-inline query-form-container" id="form-header">
                    <input type="hidden" id="id" th:value="${po.id}"/>
                    <input type="hidden" id="version" th:value="${po.version}"/>
                    <input id="code" type="hidden" name="code" th:value="${po.code == null ? '1' : po.code}">
                    <!--                    <div class="form-group">-->
                    <!--                        <label class="col-form-label mr-2">生产单号</label>-->
                    <!--                        <input class="form-control" type="text" id="code" name="code" readonly th:value="${po.code}">-->
                    <!--                    </div>-->
                    <div class="form-group" sec:authorize="hasAuthority('produce_order_add')">
                        <label class="col-form-label mr-2 required" for="partnerId">客户</label>
                        <sp:select id="partnerId" name="partnerId" key="core_partner_customer" th:value="${po.partnerId}" class="form-control" required th:attr="disabled=${po.id != null}" emptyItemText="&nbsp;"/>
                    </div>
                    <div class="form-group" sec:authorize="hasAuthority('produce_order_add')">
                        <label class="col-form-label mr-2 required" for="contactPerson">联系人</label>
                        <input class="form-control" type="text" id="contactPerson" th:value="${po.contactPerson}" name="contactPerson" required>
                    </div>
                    <div class="form-group" sec:authorize="hasAuthority('produce_order_add')">
                        <label class="col-form-label mr-2 required" for="contactNumber">联系电话</label>
                        <input class="form-control" type="text" id="contactNumber" th:value="${po.contactNumber}" name="contactNumber" required>
                    </div>
                    <div class="form-group" sec:authorize="hasAuthority('produce_order_add')">
                        <label class="col-form-label mr-2" for="contactMail">联系邮箱</label>
                        <input class="form-control" type="text" id="contactMail" th:value="${po.contactMail}" name="contactMail">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label mr-2">状态</label>
                        <sp:select id="status" name="status" key="produce_order_status" class="form-control" th:value="${po.status}" hideAllItem/>
                        <!--                        <select class="form-control" name="status">-->
                        <!--                            <option value="PROCESSING" th:selected="${'PROCESSING' eq po.status.toString()}">进行中</option>-->
                        <!--                            <option value="DONE" th:selected="${'DONE' eq po.status.toString()}">已完成</option>-->
                        <!--                        </select>-->
                    </div>
                    <div class="form-group" sec:authorize="hasAuthority('produce_order_add')">
                        <label class="col-form-label mr-2" for="remark">客户订单号</label>
                        <input class="form-control" type="text" id="sourceOrderNum" name="sourceOrderNum" th:value="${po.sourceOrderNum}">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label mr-2" for="remark">下单日期</label>
                        <input class="form-control" type="text" id="orderDate" name="orderDate" th:value="${po.orderDate}">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label mr-2" for="remark">备注</label>
                        <input class="form-control" type="text" id="remark" name="remark" th:value="${po.remark}">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label mr-2" for="remark">附件</label>
                        <div class="attachment">
                            <input type="file" multiple="multiple" name="attachment_file" id="attachment_file" data-group-name="sales" onchange="upload.ajaxFileUpload()" style="width: 99px;">
                            <input type="text" style="display:none;" name="attachmentList" id="attachmentList" th:value="${po.attachmentList ne null ? T(com.rick.common.util.JsonUtils).toJson(po.attachmentList) : '[]'}">

                            <th:block th:if="${po.attachmentList ne null}">
                                <div class="item" th:each="f : ${po.attachmentList}">
                                    <a th:text="${f.fullName}" th:href="${f.url}" target="_blank"></a><button type="button" class="btn btn-link attachment_delete_btn" th:onclick="upload.deleteAttachment([[${f.id}]], this)">删除</button>
                                </div>
                            </th:block>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <form class="form-item" id="form-item">
                    <div id="table-container">
                    </div>
                    <div class="pull-right mt-2 mr-5 footer">
                        <label>订单号：</label><span class="bold" th:text="${po.code}" id="code_text"></span>
                        <label>创建人：</label><span class="bold" th:text="${createName}"></span>
                        <label>创建时间：</label><span id="createTime" class="bold" th:text="${createTime}"></span>
                        <th:block sec:authorize="hasAuthority('produce_order_add')">
                            <label>预计本单应付：</label><span class="bold" id="total_amount" style="color: #f86c6b;">0</span>元
                        </th:block>
                        <input type="hidden" name="totalAmount" id="totalAmount">
                    </div>
                </form>
            </div>
        </div>

        <div class="nav-tabs-boxed mb-5">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#tab-1" role="tab" aria-controls="home" aria-selected="false">BOM</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-4" role="tab" aria-controls="home" aria-selected="false">生产计划</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-2" role="tab" aria-controls="home" aria-selected="false" th:if="${po.id != null}">领料记录</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-6" role="tab" aria-controls="home" aria-selected="false" th:if="${po.id != null}">采购信息</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-5" role="tab" aria-controls="home" aria-selected="false">客户收货信息</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-3" role="tab" aria-controls="home" aria-selected="false" th:if="${po.id != null}">出货记录</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="tab-1" role="tabpanel">
                    <div id="form-detail">
                        <div v-show="form.id" v-cloak>
                            <div class="card-body-scroll-panel">
                                <label sec:authorize="hasAuthority('produce_order_edit')"><a href="javascript:;" @click="copyBOM">复制 BOM</a></label>
                                <div v-for="c in form.componentList">
                                    <!--                                        <div class="component-name" v-text="c.description + '（' + c.quantity + c.unitText + '）'"></div>-->
                                    <form class="form-item">
                                        <div class="table-fixed-container">
                                            <table class="table-tbody table-editor table table-responsive-sm table-bordered table-sm">
                                                <thead>
                                                <tr>
                                                    <th><label class="required">零部件物料</label></th>
                                                    <th><label>名称</label></th>
                                                    <th><label>规格</label></th>
                                                    <th><label class="required">特征值</label></th>
                                                    <th style="width: 80px;"><label>用量</label></th>
                                                    <th style="width: 80px;"><label>单位</label></th>
                                                    <th><label>备注</label></th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr v-for="d in c.componentDetailList">
                                                    <template v-if="!d.bomTemplate">
                                                        <td style="padding: 0;"><input class="form-control material" type="text" :disabled="d.type === 'MATERIAL'" :readonly="d.type === 'MATERIAL'" autocomplete="off" name="materialCode" v-model="d.value.materialCode" :component_detail_id="d.id" :component_id="d.componentId" :type_instance_id="d.typeInstanceId" required="required" :placeholder="d.placeholder" @click="showMaterialDialog" @keydown.delete="removeMaterial(d)"><input class="form-control" type="hidden" name="materialId" v-model="d.value.materialId" required="required" value=""></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialName" v-model="d.value.materialName"></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialSpecification" v-model="d.value.materialSpecification"></td><td class="characteristic-td"><input class="form-control" type="text" value="" autocomplete="off" name="characteristic" required="required" title="请填写特征值" @click="show" :value="d.classificationList.length > 0 ? d.classificationList[0].classification.characteristicValue.map(c => c.value).join(' ') : ''" style="text-align: left;" :disabled="!(d.value.materialCode && d.classificationList.length > 0)" :readonly="!(d.value.materialCode && d.classificationList.length > 0)"><div class="characteristic-popup" style="position: fixed; z-index: 999;padding: 12px; background: #ffffff; z-index: 999; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.12); display: none;"><div class="items"><template v-for="classification in d.classificationList"><div :data-classification_code="classification.classification.code"><div class="mb-2" v-for="characteristic in classification.classification.characteristicValue"><label style="width: 60px; text-align: left;" :class="characteristic.required ? 'required' : ''" :for="characteristic.code" v-text="characteristic.description"></label><input class="form-control" style="display:inline-block; border: 1px solid #e4e7ea; width: auto;" type="text" v-if="!characteristic.options" :id="characteristic.code" :name="characteristic.code" :required="characteristic.required" v-model="characteristic.value" :placeholder="characteristic.placeholder" :pattern="characteristic.type === 'NUMBER' ? '-?\\d+(\\.\\d+)?' : ''"><select class="form-control" v-else style="display: inline-block; width: auto;border-width: 1px;" :id="characteristic.code" :name="characteristic.code" :required="characteristic.required" v-model="characteristic.value"><option value=""></option><option v-for="option in characteristic.options" :name="option.name" v-text="option.label"></option></select></div></div></template></div></div></td><td><input class="form-control" type="text" autocomplete="off" pattern="^\d+(\.\d{1,3})?$" title="必须数字" name="quantity" v-model="d.quantity" :disabled="!d.modifyQuantity" required="required"></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="unitText" v-model="d.value.unitText" required="required"><input class="form-control" type="hidden" name="unit" required="required" v-model="d.value.unit"></td><td v-if="!d.bomTemplate" style="padding: 0;"><input class="form-control" type="text" v-model="d.value.remark" autocomplete="off" name="remark"></td>
                                                    </template>

                                                    <!--第二层-->
                                                    <td colspan="7" v-if="d.bomTemplate">
                                                        <div class="component-name2"><span v-text="d.value.materialText + ' ' +  d.value.quantity + '套'"></span></span></div>
                                                        <div v-for="cc in d.bomTemplate.componentList" style="padding-left: 16px">
                                                            <!--                                                                <div class="component-name2" v-text="cc.description + '（' + cc.quantity + cc.unitText + '）'"></div>-->
                                                            <!-- -->
                                                            <form class="form-item">
                                                                <div class="table-fixed-container2">
                                                                    <table class="table-tbody table-editor table table-responsive-sm table-bordered table-sm">
                                                                        <thead>
                                                                        <tr>
                                                                            <th><label class="required">零部件物料</label></th>
                                                                            <th><label>名称</label></th>
                                                                            <th><label>规格</label></th>
                                                                            <th><label class="required">特征值</label></th>
                                                                            <th style="width: 80px;"><label>用量</label></th>
                                                                            <th style="width: 80px;"><label>单位</label></th>
                                                                            <th><label>备注</label></th>
                                                                        </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                        <tr v-for="dd in cc.componentDetailList">
                                                                            <template v-if="!dd.bomTemplate">
                                                                                <td style="padding: 0;"><input class="form-control material" type="text" :disabled="dd.type === 'MATERIAL'" :readonly="dd.type === 'MATERIAL'" autocomplete="off" name="materialCode" v-model="dd.value.materialCode" :component_detail_id="dd.id" :component_id="dd.componentId" :type_instance_id="dd.typeInstanceId" required="required" :placeholder="dd.placeholder" @click="showMaterialDialog" @keydown.delete="removeMaterial(dd)"><input class="form-control" type="hidden" name="materialId" v-model="dd.value.materialId" required="required" value=""></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialName" v-model="dd.value.materialName"></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialSpecification" v-model="dd.value.materialSpecification"></td><td class="characteristic-td"><input class="form-control" type="text" value="" autocomplete="off" name="characteristic" required="required" title="请填写特征值" @click="show" :value="dd.classificationList.length > 0 ? dd.classificationList[0].classification.characteristicValue.map(c => c.value).join(' ') : ''" style="text-align: left;" :disabled="!(dd.value.materialCode && dd.classificationList.length > 0)" :readonly="!(dd.value.materialCode && dd.classificationList.length > 0)"><div class="characteristic-popup" style="position: fixed; z-index: 999;padding: 12px; background: #ffffff; z-index: 999; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.12); display: none;"><div class="items"><template v-for="classification in dd.classificationList"><div :data-classification_code="classification.classification.code"><div class="mb-2" v-for="characteristic in classification.classification.characteristicValue"><label style="width: 60px; text-align: left;" :class="characteristic.required ? 'required' : ''" :for="characteristic.code" v-text="characteristic.description"></label><input class="form-control" style="display:inline-block; border: 1px solid #e4e7ea; width: auto;" type="text" v-if="!characteristic.options" :id="characteristic.code" :name="characteristic.code" :required="characteristic.required" v-model="characteristic.value" :placeholder="characteristic.placeholder" :pattern="characteristic.type === 'NUMBER' ? '-?\\d+(\\.\\d+)?' : ''"><select class="form-control" v-else style="display: inline-block; width: auto;border-width: 1px;" :id="characteristic.code" :name="characteristic.code" :required="characteristic.required" v-model="characteristic.value"><option value=""></option><option v-for="option in characteristic.options" :name="option.name" v-text="option.label"></option></select></div></div></template></div></div></td><td><input class="form-control" type="text" autocomplete="off" pattern="^\d+(\.\d{1,3})?$" title="必须数字" name="quantity" v-model="dd.quantity" :disabled="!dd.modifyQuantity" required="required"></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="unitText" v-model="dd.value.unitText" required="required"><input class="form-control" type="hidden" name="unit" required="required" v-model="dd.value.unit"></td><td v-if="!dd.bomTemplate" style="padding: 0;"><input class="form-control" type="text" v-model="dd.value.remark" autocomplete="off" name="remark"></td>
                                                                            </template>
                                                                            <!--第三层-->
                                                                            <td colspan="7" v-if="dd.bomTemplate">
                                                                                <div class="component-name2"><span v-text="dd.value.materialText + ' ' +  dd.value.quantity + '套'"></span></span></div>
                                                                                <div v-for="ccc in dd.bomTemplate.componentList" style="padding-left: 16px">
                                                                                    <!--                                                                                        <div class="component-name2" v-text="ccc.description + '（' + ccc.quantity + ccc.unitText + '）'"></div>-->
                                                                                    <!-- -->
                                                                                    <form class="form-item">
                                                                                        <div class="table-fixed-container2">
                                                                                            <table class="table-tbody table-editor table table-responsive-sm table-bordered table-sm">
                                                                                                <thead>
                                                                                                <tr>
                                                                                                    <th><label class="required">零部件物料</label></th>
                                                                                                    <th><label>名称</label></th>
                                                                                                    <th><label>规格</label></th>
                                                                                                    <th><label class="required">特征值</label></th>
                                                                                                    <th style="width: 80px;"><label>用量</label></th>
                                                                                                    <th style="width: 80px;"><label>单位</label></th>
                                                                                                    <th><label>备注</label></th>
                                                                                                </tr>
                                                                                                </thead>
                                                                                                <tbody>
                                                                                                <tr v-for="ddd in ccc.componentDetailList">
                                                                                                    <template  v-if="!ddd.bomTemplate">
                                                                                                        <td style="padding: 0;"><input class="form-control material" type="text" :disabled="ddd.type === 'MATERIAL'" :readonly="ddd.type === 'MATERIAL'" autocomplete="off" name="materialCode" v-model="ddd.value.materialCode" :component_detail_id="ddd.id" :component_id="ddd.componentId" :type_instance_id="ddd.typeInstanceId" required="required" :placeholder="ddd.placeholder" @click="showMaterialDialog" @keydown.delete="removeMaterial(ddd)"><input class="form-control" type="hidden" name="materialId" v-model="ddd.value.materialId" required="required" value=""></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialName" v-model="ddd.value.materialName"></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialSpecification" v-model="ddd.value.materialSpecification"></td><td class="characteristic-td"><input class="form-control" type="text" value="" autocomplete="off" name="characteristic" required="required" title="请填写特征值" @click="show" :value="ddd.classificationList.length > 0 ? ddd.classificationList[0].classification.characteristicValue.map(c => c.value).join(' ') : ''" style="text-align: left;" :disabled="!(ddd.value.materialCode && ddd.classificationList.length > 0)" :readonly="!(ddd.value.materialCode && ddd.classificationList.length > 0)"><div class="characteristic-popup" style="position: fixed; z-index: 999;padding: 12px; background: #ffffff; z-index: 999; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.12); display: none;"><div class="items"><template v-for="classification in ddd.classificationList"><div :data-classification_code="classification.classification.code"><div class="mb-2" v-for="characteristic in classification.classification.characteristicValue"><label style="width: 60px; text-align: left;" :class="characteristic.required ? 'required' : ''" :for="characteristic.code" v-text="characteristic.description"></label><input class="form-control" style="display:inline-block; border: 1px solid #e4e7ea; width: auto;" type="text" v-if="!characteristic.options" :id="characteristic.code" :name="characteristic.code" :required="characteristic.required" v-model="characteristic.value" :placeholder="characteristic.placeholder" :pattern="characteristic.type === 'NUMBER' ? '-?\\d+(\\.\\d+)?' : ''"><select class="form-control" v-else style="display: inline-block; width: auto;border-width: 1px;" :id="characteristic.code" :name="characteristic.code" :required="characteristic.required" v-model="characteristic.value"><option value=""></option><option v-for="option in characteristic.options" :name="option.name" v-text="option.label"></option></select></div></div></template></div></div></td><td><input class="form-control" type="text" autocomplete="off" pattern="^\d+(\.\d{1,3})?$" title="必须数字" name="quantity" v-model="ddd.quantity" :disabled="!ddd.modifyQuantity" required="required"></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="unitText" v-model="ddd.value.unitText" required="required"><input class="form-control" type="hidden" name="unit" required="required" v-model="ddd.value.unit"></td><td v-if="!ddd.bomTemplate" style="padding: 0;"><input class="form-control" type="text" v-model="ddd.value.remark" autocomplete="off" name="remark"></td>
                                                                                                    </template>

                                                                                                    <!--第四层-->
                                                                                                    <td colspan="7" v-if="ddd.bomTemplate">
                                                                                                        <div class="component-name2"><span v-text="ddd.value.materialText + ' ' +  ddd.value.quantity + '套'"></span></span></div>
                                                                                                        <div v-for="cccc in ddd.bomTemplate.componentList" style="padding-left: 16px">
                                                                                                            <!--                                                                                                                <div class="component-name2" v-text="cccc.description + '（' + cccc.quantity + cccc.unitText + '）'"></div>-->
                                                                                                            <!-- -->
                                                                                                            <form class="form-item">
                                                                                                                <div class="table-fixed-container2">
                                                                                                                    <table class="table-tbody table-editor table table-responsive-sm table-bordered table-sm">
                                                                                                                        <thead>
                                                                                                                        <tr>
                                                                                                                            <th><label class="required">零部件物料</label></th>
                                                                                                                            <th><label>名称</label></th>
                                                                                                                            <th><label>规格</label></th>
                                                                                                                            <th><label class="required">特征值</label></th>
                                                                                                                            <th style="width: 80px;"><label>用量</label></th>
                                                                                                                            <th style="width: 80px;"><label>单位</label></th>
                                                                                                                            <th><label>备注</label></th>
                                                                                                                        </tr>
                                                                                                                        </thead>
                                                                                                                        <tbody>
                                                                                                                        <tr v-for="dddd in cccc.componentDetailList">
                                                                                                                            <td style="padding: 0;"><input class="form-control material" type="text" :disabled="dddd.type === 'MATERIAL'" :readonly="dddd.type === 'MATERIAL'" autocomplete="off" name="materialCode" v-model="dddd.value.materialCode" :component_detail_id="dddd.id" :component_id="dddd.componentId" :type_instance_id="dddd.typeInstanceId" required="required" :placeholder="dddd.placeholder" @click="showMaterialDialog" @keydown.delete="removeMaterial(dddd)"><input class="form-control" type="hidden" name="materialId" v-model="dddd.value.materialId" required="required" value=""></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialName" v-model="dddd.value.materialName"></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="materialSpecification" v-model="dddd.value.materialSpecification"></td><td class="characteristic-td"><input class="form-control" type="text" value="" autocomplete="off" name="characteristic" required="required" title="请填写特征值" @click="show" :value="dddd.classificationList.length > 0 ? dddd.classificationList[0].classification.characteristicValue.map(c => c.value).join(' ') : ''" style="text-align: left;" :disabled="!(dddd.value.materialCode && dddd.classificationList.length > 0)" :readonly="!(dddd.value.materialCode && dddd.classificationList.length > 0)"><div class="characteristic-popup" style="position: fixed; z-index: 999;padding: 12px; background: #ffffff; z-index: 999; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.12); display: none;"><div class="items"><template v-for="classification in dddd.classificationList"><div :data-classification_code="classification.classification.code"><div class="mb-2" v-for="characteristic in classification.classification.characteristicValue"><label style="width: 60px; text-align: left;" :class="characteristic.required ? 'required' : ''" :for="characteristic.code" v-text="characteristic.description"></label><input class="form-control" style="display:inline-block; border: 1px solid #e4e7ea; width: auto;" type="text" v-if="!characteristic.options" :id="characteristic.code" :name="characteristic.code" :required="characteristic.required" v-model="characteristic.value" :placeholder="characteristic.placeholder" :pattern="characteristic.type === 'NUMBER' ? '-?\\d+(\\.\\d+)?' : ''"><select class="form-control" v-else style="display: inline-block; width: auto;border-width: 1px;" :id="characteristic.code" :name="characteristic.code" :required="characteristic.required" v-model="characteristic.value"><option value=""></option><option v-for="option in characteristic.options" :name="option.name" v-text="option.label"></option></select></div></div></template></div></div></td><td><input class="form-control" type="text" autocomplete="off" pattern="^\d+(\.\d{1,3})?$" title="必须数字" name="quantity" v-model="dddd.quantity" :disabled="!dddd.modifyQuantity" required="required"></td><td><input class="form-control" type="text" value="" autocomplete="off" disabled="disabled" readonly="readonly" name="unitText" v-model="dddd.value.unitText" required="required"><input class="form-control" type="hidden" name="unit" required="required" v-model="dddd.value.unit"></td><td v-if="!dddd.bomTemplate" style="padding: 0;"><input class="form-control" type="text" v-model="dddd.value.remark" autocomplete="off" name="remark"></td>
                                                                                                                        </tr>
                                                                                                                        </tbody>
                                                                                                                    </table>
                                                                                                                </div>
                                                                                                            </form>
                                                                                                            <!-- -->
                                                                                                        </div>
                                                                                                    </td>
                                                                                                </tr>
                                                                                                </tbody>
                                                                                            </table>
                                                                                        </div>
                                                                                    </form>
                                                                                    <!-- -->
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </form>
                                                            <!-- -->
                                                        </div>
                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="attachment mt-2">
                            <input type="file" multiple="multiple" name="attachment_file2" id="attachment_file2" data-group-name="bom" onchange="ajaxFileUpload()" style="width: 99px;">

                            <div class="item" v-for="f in form.attachmentList" :key="f.id">
                                <a v-text="f.fullName" :href="f.url" target="_blank"></a><button type="button" class="btn btn-link attachment_delete_btn" @click="deleteFile(f.id)">删除</button>
                            </div>
                        </div>

                        <div id="materialDetailInput" style="display: none"></div>
                        <div id="materialBOMTemplete" style="display: none"></div>
                    </div>
                </div>
                <div class="tab-pane" id="tab-4" role="tabpanel">
                    <div id="schedule">
                        <div id="schedule-table-container">
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tab-2" role="tabpanel">
                    <div id="goods_receipt_container" role="tabpanel">
                        <div class="table-fixed-container">
                            <table class="table table-responsive-sm table-bordered table-striped table-sm table-thead">
                                <thead>
                                <tr>
                                    <th style="width: 50px" data-index>序号</th>
                                    <th style="width: 100px" class="sortable active asc">物料</th>
                                    <th style="width: 100px;">名称</th>
                                    <th>规格</th>
                                    <th>特征值</th>
                                    <th style="width: 100px">基本单位</th>
                                    <th style="width: 100px" class="sortable text-right">应领料数量</th>
                                    <th style="width: 120px" class="sortable text-right" data-sort-type="number">已领料数量</th>
                                    <th style="width: 120px" class="sortable text-right" data-sort-type="number">待领料数量</th>
                                    <th style="width: 90px" class="sortable">状态</th>
                                </tr>
                                </thead>
                            </table>
                            <table class="table table-responsive-sm table-bordered table-striped table-sm table-tbody">
                                <tbody>
                                <tr th:each="s: ${goodsReceiptItemList}">
                                    <td th:text="${sStat.index + 1}" data-index></td>
                                    <td th:text="${s.materialCode}" th:data-sort-value="${s.materialCode}"></td>
                                    <td th:text="${s.materialName}" th:data-sort-value="${s.materialName}"></td>
                                    <td th:text="${s.materialSpecification}" th:data-sort-value="${s.materialSpecification}"></td>
                                    <td th:text="${s.characteristic}" th:data-sort-value="${s.characteristic}"></td>
                                    <td th:text="${s.unitText}" th:data-sort-value="${s.unitText}"></td>
                                    <td th:text="${#numbers.formatDecimal(s.quantity,1,'COMMA',2,'POINT')}" th:data-sort-value="${s.quantity}" th:class="text-right"></td>
                                    <td th:text="${#numbers.formatDecimal(s.goodsReceiptQuantity,1,'COMMA',2,'POINT')}" th:data-sort-value="${s.goodsReceiptQuantity}" th:class="text-right"></td>
                                    <td th:text="${#numbers.formatDecimal(s.openQuantity,1,'COMMA',2,'POINT')}" th:data-sort-value="${s.openQuantity}" th:class="text-right"></td>
                                    <td th:class="${'status-' + s.complete}" th:data-sort-value="${s.complete}" th:text="${s.complete == true ? '已完成' : '未完成'}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tab-6" role="tabpanel">
                    <div id="related_purchase_order" role="tabpanel">
                        <div class="table-fixed-container">
                            <table class="table table-responsive-sm table-bordered table-striped table-sm table-thead">
                                <thead>
                                <tr>
                                    <th style="width: 50px" data-index>序号</th>
                                    <th style="width: 100px" class="sortable active asc">物料</th>
                                    <th style="width: 100px;">名称</th>
                                    <th>规格 & 特征值</th>
                                    <th style="width: 100px" class="sortable text-right">采购数量</th>
                                    <th style="width: 100px">基本单位</th>
                                    <th style="width: 120px">采购订单</th>
                                    <th style="width: 160px">采购时间</th>
                                </tr>
                                </thead>
                            </table>
                            <table class="table table-responsive-sm table-bordered table-striped table-sm table-tbody">
                                <tbody>
                                    <tr th:each="s: ${relatedPurchaseOrderList}">
                                        <td th:text="${sStat.index + 1}" data-index></td>
                                        <td th:text="${s.materialCode}" th:data-sort-value="${s.materialCode}"></td>
                                        <td th:text="${s.materialName}" th:data-sort-value="${s.materialName}"></td>
                                        <td th:text="${s.materialSpecification + '' + s.characteristic}" ></td>
                                        <td th:text="${#numbers.formatDecimal(s.quantity,1,'COMMA',2,'POINT')}" th:data-sort-value="${s.quantity}" th:class="text-right"></td>
                                        <td th:text="${s.unitText}" th:data-sort-value="${s.unitText}"></td>
                                        <td>
                                            <a href="javascript:;" th:text="${s.purchaseOrderCode}" th:onclick="openOnNewTab('[(${s.purchaseOrderCode})]', '[(${\'/purchase_order/code/\' + s.purchaseOrderCode})]', '[(${s.purchaseOrderCode})]')"></a>
                                        </td>
                                        <td th:text="${#temporals.format(s.createTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tab-5" role="tabpanel">
                    <form id="receiveContactInfo">
                        <div class="form-group row">
                            <label class="col-sm-1 col-form-label">联系人</label>
                            <div class="col-sm-4">
                                <input class="form-control" type="text" name="receiveContactPerson">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-1 col-form-label">联系电话</label>
                            <div class="col-sm-4">
                                <input class="form-control" type="text" name="receiveContactNumber">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-1 col-form-label">联系邮箱</label>
                            <div class="col-sm-4">
                                <input class="form-control" type="text" name="receiveContactMail" placeholder="可选">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-1 col-form-label">收货地址</label>
                            <div class="col-sm-11">
                                <input class="form-control" type="text" name="address">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="tab-pane" id="tab-3" role="tabpanel" th:if="${po.id != null}">
                    <div id="goods_issue_container" role="tabpanel">
                        <div class="table-fixed-container">
                            <table class="table table-responsive-sm table-bordered table-striped table-sm table-thead" style="margin-bottom: 0">
                                <thead>
                                <tr>
                                    <th style="width: 50px" data-index>序号</th>
                                    <th style="width: 100px" class="sortable active asc">物料</th>
                                    <th>名称</th>
                                    <th>规格</th>
                                    <th>特征值</th>
                                    <th style="width: 100px">基本单位</th>
                                    <th style="width: 100px" class="sortable text-right">订单数量</th>
                                    <th style="width: 120px" class="sortable text-right" data-sort-type="number">已出货数量</th>
                                    <th style="width: 120px" class="sortable text-right" data-sort-type="number">待出货数量</th>
                                    <th style="width: 90px" class="sortable">状态</th>
                                    <th style="width: 120px">物料凭证</th>
                                </tr>
                                </thead>
                            </table>
                            <table class="table table-responsive-sm table-bordered table-striped table-sm table-tbody" style="margin-bottom: 0">
                                <tbody>
                                <tr th:each="s: ${goodsIssueItemList}">
                                    <td th:text="${sStat.index + 1}" data-index></td>
                                    <td th:text="${s.materialCode}" th:data-sort-value="${s.materialCode}"></td>
                                    <td th:text="${s.materialName}" th:data-sort-value="${s.materialName}"></td>
                                    <td th:text="${s.materialSpecification}" th:data-sort-value="${s.materialSpecification}"></td>
                                    <td th:text="${s.characteristic}" th:data-sort-value="${s.characteristic}"></td>
                                    <td th:text="${s.unitText}" th:data-sort-value="${s.unitText}"></td>
                                    <td th:text="${#numbers.formatDecimal(s.quantity,1,'COMMA',2,'POINT')}" th:data-sort-value="${s.quantity}" th:class="text-right"></td>
                                    <td th:text="${#numbers.formatDecimal(s.goodsIssueQuantity,1,'COMMA',2,'POINT')}" th:data-sort-value="${s.goodsIssueQuantity}" th:class="text-right"></td>
                                    <td th:text="${#numbers.formatDecimal(s.openQuantity,1,'COMMA',2,'POINT')}" th:data-sort-value="${s.openQuantity}" th:class="text-right"></td>
                                    <td th:class="${'status-' + s.complete}" th:data-sort-value="${s.complete}" th:text="${s.complete == true ? '已完成' : '未完成'}"></td>
                                    <td>
                                        <a href="javascript:;" th:onclick="openOnNewTab('[(${s.id})]', '[(${\'/reports/699659248728047616?root_reference_code=\'+s.produceOrderCode+\'&root_reference_item_id=\'+s.id+\'&material_id=\' + s.materialId})]', '物料凭证')">详情</a>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dialogInput" style="display: none"></div>
        <div class="operator-bar text-center" id="operator-bar" sec:authorize="hasAuthority('produce_order_edit')">
            <button class="btn btn-primary" type="button" name="send" onclick="send()" th:if="${po.id == null}">
                <i class="fa fa-save"></i> 保存并继续添加</button>

            <button class="btn btn-primary" type="button" name="send" onclick="send()" th:if="${po.id}">
                <i class="fa fa-save"></i> 保存</button>
        </div>
    </div>
</th:block>
<th:block th:replace="includes/base :: common_js(~{::script})">
    <script th:src="@{/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js}"></script>
    <script th:src="@{/plugins/bootstrap-datepicker/js/bootstrap-datepicker.zh-CN.min.js}"></script>
    <script type="text/javascript" th:src="@{/plugins/jquery.form2json.js}"></script>
    <script type="text/javascript" th:src="@{/js/table/jquery.formautofill.min.js}"></script>
    <script th:src="@{/plugins/multiple-select/multiple-select.min.js}"></script>

    <script th:src="@{/editable-table/editable-table.js}"></script>
    <script th:src="@{/js/jquery.table.js}"></script>
    <script th:src="@{/js/editable-table-plus.js}"></script>

    <script th:src="@{/js/jquery.dialogInput.js}"></script>
    <script th:src="@{/js/editable-table-plus-customize_type.js}"></script>

    <script th:src="@{/ajaxfileupload.js}"></script>
    <script th:src="@{/js/upload.js}"></script>

    <script th:inline="javascript">
        let readonly = true
        /*[# sec:authorize="hasAuthority('produce_order_add')"]*/
        readonly = false
        /*[/]*/

        let isAdd = /*[[${po.id == null}]]*/
            let formHeader = document.getElementById('form-header');
        let formItem = document.getElementById('form-item')
        let $scheduleDom = $('#schedule')
        let $receiveContactInfo = $('#receiveContactInfo')

        function showBOMDetail($tr, materialId, itemId, isCopy, callback) {
            if (materialId && $tr[0].form && materialId === $tr[0].form.materialId) {
                vue.$data.form = $tr[0].form
            } else if (materialId) {
                $.get('/produce_orders/bom?materialId=' + materialId + (itemId ? ('&itemId=' + itemId) : '') + (isCopy != undefined ? ('&isCopy=' + isCopy) : ''), function (res) {
                    let bomTemplate = res.bomTemplate
                    bomTemplate.attachmentList = []

                    bomTemplate.materialId = materialId
                    $tr[0].form = vue.$data.form = bomTemplate
                    callback && callback($tr[0].form)

                    if (itemId) {
                        characteristic.setCharacteristic($tr, res.item)
                    }
                })
            }
        }

        $('#orderDate').datepicker({
            language: "zh-CN",
            autoclose: true,
            clearBtn: true,
            todayBtn: 'linked',
            todayHighlight: true,
            format: 'yyyy-mm-dd'
        })

        if (isAdd) {
            let customerContactInfoMap = /*[[${customerContactInfoMap}]]*/
                $('#partnerId option').each(function () {
                    if (this.value) {
                        $(this).data('contactPerson', customerContactInfoMap[this.value]['contactPerson'])
                        $(this).data('contactNumber', customerContactInfoMap[this.value]['contactNumber'])
                        $(this).data('contactMail', customerContactInfoMap[this.value]['contactMail'])
                    }
                })
        }

        $('#partnerId').multipleSelect({
            filter: true,
            onClick: function (view) {
                // selected:true, text:"111", value:"731689942480101376", "data": {}
                if (view.data) {
                    $('#contactPerson').val(view.data.contactPerson)
                    $('#contactNumber').val(view.data.contactNumber)
                    $('#contactMail').val(view.data.contactMail)
                }
            }
        })

        // 可编辑表格初始化
        let $editableTable = $('#table-container').editableTablePlus({
            customizeType,
            showRowNumber: true, // 是否显示行号
            allowEmpty: false, // 表格允许为空,
            highlight: true,
            readonly,
            rowClick: function (context, $tr, row, fromActiveRow) {
                if (!$tr[0].form) {
                    $tr[0].form = {'attachmentList': []}
                }

                if (row.materialId) {
                    if (row.materialType === 'FERT' || row.materialType === 'HALB') {
                        // 成品 或 半成品
                        showBOMDetail($tr, row.materialId, row.id)
                        $scheduleDom.show()
                    } else {
                        // $tr[0].form = vue.$data.form  = {}
                        vue.$data.form = $tr[0].form
                        $scheduleDom.hide()
                    }
                } else {
                    // $tr[0].form = vue.$data.form  = {}
                    vue.$data.form = $tr[0].form
                    $scheduleDom.hide()
                }

                // 保存 schedule && receiveContactInfo
                if (fromActiveRow) {
                    fromActiveRow.$tr[0].schedule = $scheduleTable.editableTablePlus('getValue')
                    fromActiveRow.$tr[0].receiveContactInfo = $receiveContactInfo.form2json({allowEmptyMultiVal:true})
                }

                if (row.materialId) {
                    $scheduleTable.editableTablePlus('setValue', $tr[0].schedule)
                    $scheduleTable.editableTablePlus('mergeValue', {
                        "unit": row.unit,
                        "unitText": row.unitText,
                    }, undefined, false)
                } else {
                    $scheduleTable.editableTablePlus('setValue', [])
                }

                $receiveContactInfo.autofill({...{
                        'receiveContactPerson': '',
                        'receiveContactNumber': '',
                        'receiveContactMail': '',
                        'address': '',
                    }, ...$tr[0].receiveContactInfo})
            },
            beforeDeleteRow: function (context, $tr, row) {
                // 删除对应的物料清单
                if (context.options.activeIndex === ($tr.index() + 1)) {
                    $tr[0].form = vue.$data.form  = {}
                    $tr[0].schedule = undefined
                    $scheduleDom.hide()
                }

                return true
            },
            afterDeleteRow: function () {
                calcTotalAmount()
            },
            columnConfigs: [
                {
                    type: "material",
                    name: "materialId",
                    title: "物料",
                    width: 80,
                    required: true,
                    mode: 'single', // 单选,
                    // reportId: '719185652091981824',
                    // params: {categoryId: "717389543182962688"},
                    beforeShow: function ($tr, context) {
                        return true;
                    },
                    selected: function ($tr, row) {
                        // 采购价格不需要带出来
                        $tr.find(':input[name=unitPrice]').val('')
                        // if (row.materialType !== 'HALB') {
                        // 非半成品获取特征值
                        characteristic.selectedCharacteristic($tr, row);
                        // }

                        if (row.material_type === 'FERT' || row.material_type === 'HALB') {
                            // 成品 或 半成品
                            showBOMDetail($tr, row.id, row.item_id, true, function (form) {})
                            $scheduleDom.show()
                        } else {
                            $editableTable.editableTablePlus('mergeValue', {
                                "specification": row.specification,
                            }, $tr)
                            // $tr[0].form = vue.$data.form  = {}
                             vue.$data.form = $tr[0].form = {}
                            $scheduleDom.hide()
                        }

                        $scheduleTable.editableTablePlus('mergeValue', {
                            "unit": row.base_unit,
                            "unitText": row.base_unit_name,
                        }, undefined, false)
                    }
                },
                {
                    type: "hidden",
                    name: "materialType"
                },
                {
                    type: "label",
                    name: "materialName",
                    title: "名称"
                },
                {
                    type: "text",
                    name: "specification",
                    title: "规格"
                },
                {
                    type: "characteristic",
                    name: "characteristic",
                    // width: 80,
                    title: "特征值",
                    required: true,
                    disabled: true
                },
                {
                    type: "decimal",
                    name: "quantity",
                    title: "数量",
                    width: 60,
                    required: true,
                    align: 'right',
                    keyup: function ($tr, event, value) {
                        calcAmount($tr);
                    }
                },
                {
                    type: "text_label",
                    name: "unit",
                    title: "单位",
                    width: 60,
                    disabled: true,
                    required: false,
                },
                {
                    type: "select",
                    name: "itemCategory",
                    title: "类型",
                    required: true,
                    width: 95,
                    datasource: [
                        {
                            name: "",
                            value: ""
                        },
                        {
                            name: "PRODUCT",
                            value: "产品"
                        },
                        {
                            name: "PURCHASE_SEND",
                            value: "采购直发"
                        }
                    ],
                },
                {
                    type: readonly ? "hidden": "decimal",
                    name: "unitPrice",
                    title: "含税单价",
                    align: 'right',
                    width: 80,
                    required: false,
                    keyup: function ($tr, event, value) {
                        calcAmount($tr);
                    }
                },
                {
                    type: readonly ? "hidden": "label",
                    name: "amount",
                    width: 100,
                    title: "含税总计",
                    required: false,
                },
                {
                    type: "date",
                    name: "deliveryDate",
                    width: 100,
                    title: "交货日期",
                    required: true,
                },
                {
                    type: "text",
                    title: "客户物料编号",
                    width: 120,
                    name: "customerMaterialCode",
                },
                {
                    type: "text",
                    title: "备注",
                    name: "remark",
                },
                {
                    type: (isAdd || readonly) ? "hidden": "checkbox",
                    title: "出货完成",
                    name: "complete",
                    align: 'center',
                    width: 80,
                },
                // {
                //     type: isAdd ? "hidden": "render",
                //     name: "download",
                //     title: "BOM",
                //     align: 'center',
                //     width: 80,
                //     render: function (row) {
                //         if (row.materialType === 'ROH' || !row.id) {
                //             return ''
                //         }
                //         return '<a href="/produce_bom/'+row.id+'/download" >下载</a>'
                //     }
                // }
            ]
        })
        // end

        let $scheduleTable = $('#schedule-table-container').editableTablePlus({
            showRowNumber: true, // 是否显示行号
            allowEmpty: true, // 表格允许为空,
            highlight: true,
            columnConfigs:[
                {
                    type: "hidden",
                    name: "id"
                },
                {
                    type: "date",
                    name: "startDate",
                    width: 120,
                    title: "生产日期",
                    align: 'center',
                    required: true,
                },
                {
                    type: "decimal",
                    name: "quantity",
                    title: "生产数量",
                    width: 80,
                    required: true,
                    align: 'right'
                },
                {
                    type: "text_label",
                    name: "unit",
                    title: "单位",
                    width: 60,
                    align: 'center',
                    disabled: true,
                    required: false,
                },
                {
                    type: "select",
                    name: "status",
                    title: "状态",
                    width: 100,
                    align: 'center',
                    required: true,
                    disabled: true,
                    datasource: [
                        {
                            name: "PRODUCING",
                            value: "待生产"
                        },
                        {
                            name: "PRODUCED",
                            value: "生产完成"
                        }
                    ],
                },
                {
                    type: "text",
                    name: "remark",
                    title: "备注"
                },
                {
                    type: "label",
                    name: "code",
                    width: 160,
                    title: "生产单号"
                },
                {
                    type: isAdd ? "hidden": "render",
                    title: "领料记录",
                    align: 'center',
                    width: 80,
                    render: function (row) {
                        if (row.materialType === 'ROH' || !row.code) {
                            return ''
                        }
                        return '<a href="javascript:;" onclick="openOnNewTab(\''+row.code+'\', \'/reports/699659248728047616?plantId=719893335619162112&root_reference_code='+row.code+'\', \'物料凭证\')">查看</a>'
                    }
                },
                {
                    type: isAdd ? "hidden": "render",
                    title: "BOM",
                    align: 'center',
                    width: 80,
                    render: function (row) {
                        if (row.materialType === 'ROH' || !row.id) {
                            return ''
                        }
                        return '<a href="/produce_bom/schedule/'+row.id+'/download" >下载</a>'
                    }
                },
            ],
            afterCreated() {
                // alert('created')
                $scheduleDom.hide()
            },
            addEmptyLineCallback(context, $tr) {
                let activeValue = $editableTable.editableTablePlus('getActiveRowValue')
                if (activeValue) {
                    context.mergeValue({
                        "unit": activeValue.value.unit,
                        "unitText": activeValue.value.unitText,
                    }, $tr)
                }
            }
        })

        // $('#form-item').delegate('.items select', 'change', function () {
        //     alert(11123)
        // })

        function valid() {
            var formHeaderValidity = formHeader.checkValidity()
            var formItemValidity = formItem.checkValidity()
            formHeader.classList.add('was-validated')
            formItem.classList.add('was-validated')

            if (!$('#partnerId').val()) {
                $('#partnerId').next().addClass('is-invalid')
            } else {
                $('#partnerId').next().removeClass('is-invalid')
            }

            return formHeaderValidity && formItemValidity;
        }

        function reset() {
            formHeader.classList.remove('was-validated')
            formItem.classList.remove('was-validated')

            $editableTable.editableTablePlus('clear')

            $("form.readonly :input").prop("disabled", false);
            $("form-item #table tr:last-child").prop("disabled", false);
        }

        function send() {
            if (!valid()) {
                return
            }

            let params = {}

            let detailValid = true

            params['itemList'] = $editableTable.editableTablePlus('getValue')
            characteristic.getCharacteristicParams($editableTable, params['itemList'])

            // 非 待审核状态需要完全验证
            let strictValid = false
            if ($('#status').val() !== 'PLANNING') {
                strictValid = true
            }

            // 保存当前 active 到 DOM 中
            let activeRowValue = $editableTable.editableTablePlus('getActiveRowValue')
            if (activeRowValue) {
                let activeTr = activeRowValue.$tr[0];
                activeTr.schedule = $scheduleTable.editableTablePlus('getValue')
                activeTr.receiveContactInfo = $receiveContactInfo.form2json({allowEmptyMultiVal:true})
            }

            for (let index in params['itemList']) {
                let item = params['itemList'][index]
                let trDom = $('#table-container table.table-tbody tbody tr').eq(index)[0]

                // 获取BOM
                // 获取value
                let valueList = []
                checkAndGetValueList(trDom.form, valueList, parseInt(index))
                if (!detailValid) {
                    return;
                }

                item['itemList'] = valueList

                // 附件
                item['attachmentList'] = trDom.form.attachmentList || []

                // 收货地址
                item['contactInfo'] = (trDom.receiveContactInfo && Object.values(trDom.receiveContactInfo).filter(v => v).length === 0)? {} : {
                    "contactPerson": trDom.receiveContactInfo.receiveContactPerson,
                    "contactNumber": trDom.receiveContactInfo.receiveContactNumber,
                    "contactMail": trDom.receiveContactInfo.receiveContactMail,
                    "address": trDom.receiveContactInfo.address
                }

                // 生产计划
                item['scheduleList'] = trDom.schedule
                // 检查数量
                if (item['scheduleList'] && item['scheduleList'].length > 0) {
                    for (let schedule of item['scheduleList']) {
                        if (!schedule.startDate || !schedule.quantity) {
                            toastr.error('第 '+(parseInt(index) + 1)+' 个物料生产计划填写不完整！')
                            return;
                        }
                    }

                    let total = item['scheduleList'].map(obj => obj.quantity).reduce((total, current) => math.add(math.bignumber(total), math.bignumber(current)), 0);
                    if (total.toString() !== item.quantity) {
                        detailValid = false
                        toastr.error('第 '+(parseInt(index) + 1)+' 个物料生产计划的总数量和订单数量不相等！')
                        return;
                    }
                } else {
                    if (item.materialType !== 'ROH' && strictValid && item.itemCategory === 'PRODUCT') {
                        toastr.error('第 '+(parseInt(index) + 1)+' 个物料没有填写生产计划！')
                        return;
                        // item['scheduleList'] = [{
                        //     startDate: ((d) => d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0"))(new Date()),
                        //     quantity: item.quantity,
                        //     unit: item.unit,
                        //     status: 'PRODUCING'
                        // }]
                    }
                }
                // 生产计划 end

                if (!item.contactInfo.contactPerson) {
                    item.contactInfo.contactPerson = $('#contactPerson').val()
                }

                if (!item.contactInfo.contactNumber) {
                    item.contactInfo.contactNumber = $('#contactNumber').val()
                }

                item.contactInfo.contactSubject = $('#partnerId option:selected').text()

                if (item.itemCategory === 'PURCHASE_SEND') {
                    if (!item.contactInfo.address) {
                        toastr.error('采购直发客户收货地址不能为空!')

                        return;
                    }
                }

            }


            function checkAndGetValueList(tpl, valueList, index) {
                if (!detailValid) {
                    return;
                }

                if (tpl && tpl.componentList) {
                    for(let component of tpl.componentList) {
                        for (let componentDetail of component.componentDetailList) {
                            if (!detailValid) {
                                return;
                            }

                            if (strictValid && !componentDetail.value.materialId && !(componentDetail.required === false)) {
                                toastr.error('第 '+(index + 1)+' 个物料的BOM有【物料】没有填写！')
                                detailValid = false
                                return
                            }

                            if (componentDetail.bomTemplate) {
                                checkAndGetValueList(componentDetail.bomTemplate, valueList, index)
                            } else {
                                if ((strictValid && componentDetail.value.materialId) || !strictValid) {
                                    let item = {...componentDetail.value, ...{quantity: componentDetail.quantity}}

                                    // 特征值
                                    item.classificationList = componentDetail.classificationList.map(c => {return {materialId: item.materialId, classificationCode: c.classification.code, characteristicValueList: c.classification.characteristicValue.map(ch => {return {characteristicCode: ch.code, val: ch.value, required: ch.required, type: ch.type}})}})

                                    for (let classification of item.classificationList) {
                                        for (let characteristic of classification.characteristicValueList) {
                                            if ((strictValid || componentDetail.value.materialId) && characteristic.required && !characteristic.val) {
                                                toastr.error('第 '+(index + 1)+' 行物料清单的'+componentDetail.value.materialName+'('+componentDetail.value.materialCode+')有【特征值】没有填写！')
                                                detailValid = false
                                                return
                                            }

                                            if (characteristic.val) {
                                                if (characteristic.type === 'NUMBER' && !(characteristic.val.match(/^\d+(.\d+)?$/g))) {
                                                    toastr.error('第 '+(index + 1)+' 行物料清单的'+componentDetail.value.materialName+'('+componentDetail.value.materialCode+')有【特征值】填写不正确！')
                                                    detailValid = false
                                                    return
                                                }
                                            }
                                        }
                                    }

                                    valueList.push(item)
                                }
                            }
                        }
                    }
                }
            }

            params = $.extend({},
                params, $('#form-header').form2json({allowEmptyMultiVal:true})); //合并参数

            delete params.attachment_file
            params['attachmentList'] = JSON.parse(params['attachmentList'])

            console.log(params)

            $.ajax({
                url: '/produce_orders',
                type: "POST",
                data: JSON.stringify(params),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function(res){
                    toastr.success('生产单保存成功');
                    if (isAdd) {
                        window.location = '/produce_orders/new'
                    } else {
                        $('#version').val(parseInt($('#version').val()) + 1)
                        // window.location = '/produce_orders/'+res.id+'?readonly=true'
                    }
                    reloadTab('produce_order_list')
                }
            });
        }

        $('#goods_receipt_container, #goods_issue_container, #related_purchase_order').table({
            fixedHead: true
        })

        let itemList = /*[[${po.itemList}]]*/
        let valueMap =  /*[[${bomTemplate}]]*/
        loadItem(itemList)

        function loadItem(itemList) {
            if (itemList && itemList.length > 0) {
                // 特征值
                for (let item of itemList) {
                    if (item.materialType === 'HALB') {
                        // 半成品不显示特征值
                        // item.classificationList = []
                    }
                }
                characteristic.loadCharacteristic($editableTable, itemList)
                $editableTable.editableTablePlus('setActiveIndex', 1)
                // 设置单位
                let activeValue = $editableTable.editableTablePlus('getActiveRowValue')
                if (activeValue) {
                    $scheduleTable.editableTablePlus('mergeValue', {
                        "unit": activeValue.value.unit,
                        "unitText": activeValue.value.unitText,
                    }, null, false)
                }


                calcTotalAmount()

                let $trs = $editableTable.editableTablePlus('getEditRow')
                $trs.find('[name=materialCode]').attr('disabled', true)
                // $trs.find('td.operator').hide()

                // 生产计划
                if (itemList[0].materialType !== 'ROH') {
                    $scheduleDom.show()
                    $scheduleTable.editableTablePlus('setValue', itemList[0]['scheduleList'])
                }

                let firstContactInfo;
                for(let i = 0; i < itemList.length; i++) {
                    $trs[i].schedule = itemList[i]['scheduleList']

                    if (itemList[i].contactInfo) {
                        $trs[i].receiveContactInfo = {
                            "receiveContactPerson": itemList[i].contactInfo['contactPerson'],
                            "receiveContactNumber": itemList[i].contactInfo['contactNumber'],
                            "receiveContactMail": itemList[i].contactInfo['contactMail'],
                            "address": itemList[i].contactInfo['address']
                        }
                    }
                    else {
                        $trs[i].receiveContactInfo = {}
                    }

                    if (i == 0) {
                        firstContactInfo = $trs[i].receiveContactInfo
                    }
                }

                $receiveContactInfo.autofill(firstContactInfo)
            }

            $editableTable.editableTablePlus('readonly', readonly)
        }

        function calcAmount($tr) {
            $tr.find('td input[name=amount]').val('')

            let quantity = $tr.find('td input[name=quantity]').val()
            let unitPrice = $tr.find('td input[name=unitPrice]').val()
            if (quantity && unitPrice) {
                let amount = math.multiply(math.bignumber(quantity), math.bignumber(unitPrice));
                $tr.find('td input[name=amount]').val(amount)
            }

            calcTotalAmount()
        }

        function calcTotalAmount() {
            let totalAmount = 0
            $('#table-container tbody input[name=amount]').each(function () {
                if ($(this).val()) {
                    totalAmount = math.add(math.bignumber(totalAmount), math.bignumber($(this).val()));
                }
            })
            $('#total_amount').text(totalAmount)
            $('#totalAmount').text(totalAmount)
        }

        // bom 模版
        let materialBOMTemplete = $('#materialBOMTemplete').dialogInput({
            title: '选择 BOM 模版',
            reportId: '719185652091981824',
            labelDisplay: function (row) {
                return row.name + ' ' + (!row.specification ? '' : row.specification)
            },
            selected: function (row) {
                let materialId = row.materialId
                let itemId = row.item_id
                let isCopy = true
                $.get('/produce_orders/bom?materialId=' + materialId + (itemId ? ('&itemId=' + itemId) : '') + (isCopy != undefined ? ('&isCopy=' + isCopy) : ''), function (res) {
                    // 合并remark
                    let remarks = {}
                    readTemplate(vue.$data.form, function (d) {
                        let remark = d.value.remark.trim()
                        if (remark) {
                            remarks[d.id + ''] = remark
                        }
                    })

                    function readTemplate(tpl, handler) {
                        if(tpl) {
                            for (let c of tpl.componentList) {

                                for (d of c.componentDetailList) {
                                    handler(d)
                                    if (d.bomTemplate) {
                                        readTemplate(d.bomTemplate, handler)
                                    }
                                }
                            }
                        }
                    }

                    readTemplate(res.bomTemplate, function (d) {
                        let remark = remarks[d.id + '']
                        if (remark) {
                            d.value.remark = remark
                        }
                    })
                    // 合并remark end

                    let componentList = res.bomTemplate.componentList
                    $editableTable.editableTablePlus('getActiveRowValue').$tr[0].form.componentList = vue.$data.form.componentList = componentList
                    // callback && callback($tr[0].form)

                    // if (itemId) {
                    //     characteristic.setCharacteristic($tr, res.item)
                    // }
                })
            }
        })
        // 物料清单选择 detail
        let materialDetailInput = $('#materialDetailInput').dialogInput({
            title: '选择物料',
            reportId: '697147523487240192',
            labelDisplay: function (row) {
                return row.name + ' ' + (!row.specification ? '' : row.specification)
            },
            selected: function (row) {
                console.log(row)
                if ("createEvent" in document) {
                    var evt = document.createEvent("HTMLEvents");
                    evt.initEvent("input", false, true);
                    currentMaterialDom.dispatchEvent(evt);
                }
                else
                    currentMaterialDom.fireEvent("input");

                let form_data = vue.form
                let $tr = $editableTable.editableTablePlus('getActiveRowValue').$tr

                // 递归设置物料信息
                let break_flag = false
                fill(form_data, this)
                function fill(tpl, context) {
                    if (break_flag) {
                        return
                    }

                    if(tpl) {
                        for (let c of tpl.componentList) {
                            if (break_flag) {
                                break
                            }

                            for (d of c.componentDetailList) {
                                if (d.id === currentMaterialDom.getAttribute('component_detail_id')) {
                                    d.value.is_batch = row.batchManagement
                                    d.value.materialId = row.id
                                    d.value.materialCode = row.code
                                    d.value.materialName = row.name
                                    d.value.materialSpecification = (!row.specification ? '' : row.specification)
                                    d.value.unit = row.base_unit
                                    d.value.unitText = row.base_unit_name
                                    // d.value.componentDetailId = currentMaterialDom.getAttribute('component_detail_id')

                                    // 设置特征值
                                    $.ajaxSettings.async = false
                                    $.get(`/materials/${row.id}/classifications`, (res) => {
                                        let classificationList = res.map(c => { return {"classification": c}})
                                        for (let classification of classificationList) {
                                            for (let characteristic of classification.classification.characteristicValue) {
                                                // let $select = $tr.find('[data-classification_code='+classification.classification.code+'] select[name='+characteristic.code+']')
                                                // 相同的特征，不一定相同分类
                                                let $select = $tr.find('select[name='+characteristic.code+']')
                                                if ($select.length > 0) {
                                                    characteristic.value = $select.val()
                                                }
                                            }
                                        }

                                        d.classificationList = classificationList
                                    })
                                    $.ajaxSettings.async = true

                                    // d.options = [...document.getElementById('color').options].map(o => o.text)
                                    break_flag = true
                                    break
                                }

                                //
                                if (!break_flag && d.bomTemplate) {
                                    fill(d.bomTemplate, context)
                                }
                            }
                        }
                    }
                }

                vue.form = form_data
            }
        })

        let vue = new Vue({
            el: '#form-detail',
            data: {
                form: {

                }
            },
            updated: function () {
                // if (readonly) {
                //     $('#form-detail :input').attr('disabled', true)
                // }
            },
            mounted: function () {
                if (itemList && itemList.length > 0) {
                    $editableTable
                        .editableTablePlus('each', (index, context, $tr, row) => {
                            let value = valueMap[row.id] || {}
                            value.attachmentList = itemList[index].attachmentList || []

                            if(index === 0) {
                                this.form = value
                            }

                            value.materialId = row.materialId
                            $tr[0].form = value
                        })
                }
            },
            methods: {
                deleteFile: function (id) {
                    this.form.attachmentList = this.form.attachmentList.filter(f => f.id != id)
                },
                copyBOM: function () {
                    materialBOMTemplete.dialogInput('setParams', {'materialId' : this.form.materialId})
                    materialBOMTemplete.click()
                },
                showMaterialDialog: function (e) {
                    materialDetailInput.dialogInput('setParams', {'categoryId' : e.target.getAttribute('type_instance_id')})
                    materialDetailInput.click();
                    currentMaterialDom = e.target
                },
                removeMaterial: function (d) {
                    d.classificationList = []
                    d.value = {
                        characteristic: "",
                        componentDetailId: d.value.componentDetailId,
                        materialName: "",
                        materialSpecification: "",
                        materialText: "",
                        quantity: d.value.quantity,
                        remark: "",
                        unitText: ""
                    }
                },
                show(e) {
                    $(e.target).next().css('display', 'block').css('top', ($(e.target).offset().top + 32) + 'px')
                }
            }
        })

        // if (readonly) {
        //     $editableTable.editableTablePlus('readonly', true)
        // }
        function ajaxFileUpload() {
            $.ajaxFileUpload
            (
                {
                    url: '/documents/upload?name=attachment_file2&groupName=' + $('#attachment_file2').data('group-name'), //用于文件上传的服务器端请求地址
                    secureuri: false, //是否需要安全协议，一般设置为false
                    fileElementId: 'attachment_file2', //文件上传域的ID
                    dataType: 'json', //返回值类型 一般设置为json
                    success: function (data, status) { //服务器成功响应处理函数
                        let activeTr = $editableTable.editableTablePlus('getActiveRowValue').$tr[0];
                        let attachmentList = [...activeTr.form.attachmentList, ...data.data]
                        activeTr.form.attachmentList = attachmentList
                        // upload.appendAttachment(data.data, name)
                    },
                    error: function (data, status, e) { //服务器响应失败处理函数
                        alert(e);
                    }
                }
            )
        }
    </script>
</th:block>
<style>
    @media (min-width: 576px) {.dialog-input .modal-dialog {max-width: 820px!important;}}
</style>
</body>
</html>